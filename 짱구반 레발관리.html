<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ë°˜ ì„±ì¥ ì´ì•¼ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding:wght@400;700&family=Jua&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Nanum Gothic Coding', monospace;
            background-color: #f0f9ff;
        }
        .font-jua {
            font-family: 'Jua', sans-serif;
        }
        .student-list-item {
            transition: all 0.2s ease-in-out;
        }
        .student-list-item:hover {
            transform: scale(1.05);
            background-color: #fecaca;
        }
        .tab-button {
            transition: all 0.2s;
            border-bottom: 4px solid transparent;
        }
        .tab-button.active {
            border-bottom-color: #f59e0b;
            color: #f59e0b;
        }
        .stamp-grid {
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        }
        .heart-level-1::before { content: 'â¤ï¸'; margin-right: 4px; }
        .heart-level-2::before { content: 'ğŸ’–'; margin-right: 4px; }
        .heart-level-3::before { content: 'ğŸ’'; margin-right: 4px; }

        .swal2-popup {
            font-family: 'Jua', sans-serif;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="main-container" class="max-w-7xl mx-auto">
        
        <!-- ì´ˆê¸° í™”ë©´ -->
        <div id="initial-screen" class="text-center p-8 bg-white rounded-2xl shadow-lg">
            <h1 class="text-5xl font-jua text-sky-600 mb-4">ğŸ« ìš°ë¦¬ë°˜ ì„±ì¥ ì´ì•¼ê¸° ğŸš€</h1>
            <p class="text-gray-600 mb-8">ëª¨ë“œ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”!</p>
            <div class="flex justify-center gap-4">
                <button onclick="showModeSelect('teacher')" class="px-8 py-4 bg-blue-500 text-white font-bold rounded-lg text-2xl font-jua shadow-md hover:bg-blue-600 transition">ğŸ‘©â€ğŸ« êµì‚¬ ëª¨ë“œ</button>
                <button onclick="showModeSelect('student')" class="px-8 py-4 bg-rose-500 text-white font-bold rounded-lg text-2xl font-jua shadow-md hover:bg-rose-600 transition">ğŸ’ í•™ìƒ ëª¨ë“œ</button>
            </div>
        </div>

        <!-- í•™ìƒ ì„ íƒ í™”ë©´ -->
        <div id="student-select-screen" class="hidden">
            <button onclick="showInitialScreen()" class="mb-4 px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"> &larr; ë’¤ë¡œê°€ê¸°</button>
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 id="student-select-title" class="text-3xl font-jua text-center mb-6">ëˆ„êµ¬ì¸ê°€ìš”? ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</h2>
                <div id="student-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center">
                    <!-- í•™ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
        
        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <div id="content-area" class="hidden">
            <!-- ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

    </div>

    <script>
        let currentMode = ''; // 'teacher' or 'student'
        let selectedStudentId = null;
        let activeTab = 'exp';
        let schoolData = {};

        const studentNames = ["ê±´ìš°", "ë‚˜ì˜", "ë‹¤ì†”", "ë‘˜êµ°", "ë¯¼ê²½", "ë¯¼ì¤€", "ë¯¼í•˜", "ì„œìš°", "ì†Œìœ¨", "ì˜ˆìš´", "ìœ ì§„", "ìœ¤ìš°", "ì§€í˜„", "ì¤€ìš°", "í•˜ì˜", "í•˜ì¤€", "í˜„ìˆ˜", "í˜œë‚˜"];
        studentNames.sort(); // ì´ë¦„ ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬

        const stampCategories = {
            life: ['ë´‰ì‚¬', 'ì˜ˆì˜', 'ì–‘ë³´', 'ì„±ì‹¤', 'ë°”ë¥¸ ì–¸ì–´', 'ì§ˆì„œ', 'ì±…ì„', 'í–‰ë³µ', 'ë¦¬ë”ì‹­', 'ì§‘ì¤‘ë ¥', 'ì²­ê²°', 'í˜‘ë™', 'ì„¼ìŠ¤', 'ì—´ì •', 'ë°›ì•„ì“°ê¸°', 'í‰í™”', 'ê¸°ë¶€'],
            learning: ['êµ­ì–´', 'ìˆ˜í•™', 'ì‚¬íšŒ', 'ì˜ì–´', 'ê³¼í•™', 'ì•„ì¹¨í™œë™', 'ìŒì•…', 'ë¯¸ìˆ ', 'ì²´ìœ¡', 'ë°œí‘œ', 'ìˆ˜ì—… íƒœë„', 'ì°½ì˜ë ¥', 'ë…ì„œ', 'ë°”ë¥¸ ê¸€ì”¨', 'ë…¸ë ¥', 'í•œê¸€ íƒ€ì']
        };

        // ì´ˆê¸° ë°ì´í„° ì„¤ì •
        function initializeData() {
            const initialData = {
                teacherPassword: '1006',
                students: studentNames.map((name, index) => ({
                    id: index,
                    name: name,
                    password: '0000',
                    totalExp: 0,
                    praiseHearts: 0,
                    stamps: {},
                    titles: [],
                    lastExpSubmissionDate: null,
                    pendingStamps: [] // ê°€ì¹˜ë„ì¥ ìš”ì²­ì„ ìœ„í•œ ë°°ì—´ ì¶”ê°€
                }))
            };
            // ê°€ì¹˜ë„ì¥ ì´ˆê¸°í™”
            initialData.students.forEach(student => {
                stampCategories.life.forEach(name => student.stamps[name] = 0);
                stampCategories.learning.forEach(name => student.stamps[name] = 0);
            });
            return initialData;
        }

        // ë°ì´í„° ë¡œë“œ ë° ì €ì¥
        function loadData() {
            const data = localStorage.getItem('schoolData');
            schoolData = data ? JSON.parse(data) : initializeData();
            // ë°ì´í„° êµ¬ì¡° ë³€ê²½ì— ë”°ë¥¸ í˜¸í™˜ì„± ì½”ë“œ
            schoolData.students.forEach(student => {
                if (!student.pendingStamps) {
                    student.pendingStamps = [];
                }
            });
        }

        function saveData() {
            localStorage.setItem('schoolData', JSON.stringify(schoolData));
        }

        function goBackToStudentSelect() {
            document.getElementById('content-area').classList.add('hidden');
            document.getElementById('student-select-screen').classList.remove('hidden');
            selectedStudentId = null;
        }

        // í™”ë©´ ì „í™˜ í•¨ìˆ˜
        function showInitialScreen() {
            document.getElementById('initial-screen').classList.remove('hidden');
            document.getElementById('student-select-screen').classList.add('hidden');
            document.getElementById('content-area').classList.add('hidden');
            selectedStudentId = null;
            currentMode = '';
        }

        async function showModeSelect(mode) {
            if (mode === 'teacher') {
                const { value: password } = await Swal.fire({
                    title: 'êµì‚¬ ëª¨ë“œ',
                    input: 'password',
                    inputLabel: 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
                    inputPlaceholder: 'ë¹„ë°€ë²ˆí˜¸ ì…ë ¥',
                    inputAttributes: {
                        autocapitalize: 'off',
                        autocorrect: 'off'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'í™•ì¸',
                    cancelButtonText: 'ì·¨ì†Œ'
                });

                if (password === schoolData.teacherPassword) {
                    currentMode = 'teacher';
                } else if (password) {
                    Swal.fire('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.', 'error');
                    return;
                } else {
                    return; // ì‚¬ìš©ìê°€ ì·¨ì†Œí•œ ê²½ìš°
                }
            } else {
                currentMode = mode;
            }
            
            document.getElementById('initial-screen').classList.add('hidden');
            document.getElementById('student-select-screen').classList.remove('hidden');
            
            const title = currentMode === 'teacher' ? 'ğŸ‘©â€ğŸ« ê´€ë¦¬í•  í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.' : 'ğŸ’ ë³¸ì¸ ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
            document.getElementById('student-select-title').innerText = title;

            const studentListContainer = document.getElementById('student-list');
            studentListContainer.innerHTML = '';
            schoolData.students.forEach(student => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'p-4 bg-amber-200 rounded-lg cursor-pointer student-list-item font-jua text-xl';
                studentDiv.innerText = student.name;
                studentDiv.onclick = () => handleStudentSelect(student.id);
                studentListContainer.appendChild(studentDiv);
            });
        }

        async function handleStudentSelect(studentId) {
            selectedStudentId = studentId;
            
            if (currentMode === 'teacher') {
                showContentArea();
                return;
            }

            // í•™ìƒ ëª¨ë“œì¸ ê²½ìš°ì—ë§Œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¬»ìŠµë‹ˆë‹¤.
            const student = schoolData.students.find(s => s.id === studentId);
            const { value: inputPassword } = await Swal.fire({
                title: `${student.name} í•™ìƒ`,
                input: 'password',
                inputLabel: 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
                inputPlaceholder: 'ë¹„ë°€ë²ˆí˜¸ ì…ë ¥',
                inputAttributes: {
                    autocapitalize: 'off',
                    autocorrect: 'off'
                },
                showCancelButton: true,
                confirmButtonText: 'í™•ì¸',
                cancelButtonText: 'ì·¨ì†Œ'
            });

            if (inputPassword === student.password) {
                showContentArea();
            } else if (inputPassword) {
                 Swal.fire('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        function showContentArea() {
            document.getElementById('student-select-screen').classList.add('hidden');
            document.getElementById('content-area').classList.remove('hidden');
            activeTab = 'exp';
            renderContentArea();
        }

        // ë©”ì¸ ì½˜í…ì¸  ë Œë”ë§
        function renderContentArea() {
            const student = schoolData.students.find(s => s.id === selectedStudentId);
            const level = Math.floor(student.totalExp / 100);
            const exp = student.totalExp % 100;

            const contentHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <button onclick="goBackToStudentSelect()" class="mb-2 px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">&larr; í•™ìƒì„ íƒ</button>
                            <h2 class="text-4xl font-jua">${student.name}</h2>
                            <p class="text-xl text-gray-700">ë ˆë²¨: <span class="font-bold text-green-600">${level}</span> | ê²½í—˜ì¹˜: <span class="font-bold text-blue-600">${exp} / 100</span></p>
                        </div>
                    </div>

                    <div class="border-b-2 border-gray-200 mb-4">
                        <nav class="-mb-0.5 flex space-x-6">
                            <button onclick="changeTab('exp')" class="py-4 px-1 inline-flex items-center gap-2 text-lg font-medium whitespace-nowrap text-gray-500 hover:text-amber-600 tab-button ${activeTab === 'exp' ? 'active' : ''}">ê²½í—˜ì¹˜</button>
                            <button onclick="changeTab('stamps')" class="py-4 px-1 inline-flex items-center gap-2 text-lg font-medium whitespace-nowrap text-gray-500 hover:text-amber-600 tab-button ${activeTab === 'stamps' ? 'active' : ''}">ê°€ì¹˜ë„ì¥</button>
                            <button onclick="changeTab('titles')" class="py-4 px-1 inline-flex items-center gap-2 text-lg font-medium whitespace-nowrap text-gray-500 hover:text-amber-600 tab-button ${activeTab === 'titles' ? 'active' : ''}">ì¹­í˜¸</button>
                            <button onclick="changeTab('settings')" class="py-4 px-1 inline-flex items-center gap-2 text-lg font-medium whitespace-nowrap text-gray-500 hover:text-amber-600 tab-button ${activeTab === 'settings' ? 'active' : ''}">ì„¤ì •</button>
                        </nav>
                    </div>

                    <div id="tab-content">
                        <!-- íƒ­ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            `;
            document.getElementById('content-area').innerHTML = contentHTML;
            renderTabContent();
        }

        function changeTab(tabName) {
            activeTab = tabName;
            renderContentArea();
        }

        function renderTabContent() {
            if (activeTab === 'exp') renderExpTab();
            else if (activeTab === 'stamps') renderStampsTab();
            else if (activeTab === 'titles') renderTitlesTab();
            else if (activeTab === 'settings') renderSettingsTab();
        }
        
        // ê° íƒ­ ë Œë”ë§ í•¨ìˆ˜ë“¤
        function renderExpTab() {
            const container = document.getElementById('tab-content');
            const student = schoolData.students.find(s => s.id === selectedStudentId);
            let content = '';

            if (currentMode === 'teacher') {
                content = `
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-2xl font-bold mb-4">ë ˆë²¨/ê²½í—˜ì¹˜ ìˆ˜ì •</h3>
                        <div class="flex items-center gap-4">
                            <input type="number" id="level-input" class="p-2 border rounded w-full" placeholder="ë ˆë²¨" value="${Math.floor(student.totalExp / 100)}">
                            <input type="number" id="exp-input" class="p-2 border rounded w-full" placeholder="ê²½í—˜ì¹˜" value="${student.totalExp % 100}">
                            <button onclick="updateExp()" class="px-6 py-2 bg-green-500 text-white font-bold rounded hover:bg-green-600">ìˆ˜ì •</button>
                        </div>
                    </div>
                `;
            } else {
                 const today = new Date();
                 const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                 const dayOfWeek = today.getDay(); // 0(ì¼) ~ 6(í† )
                 const canSubmit = (dayOfWeek >= 1 && dayOfWeek <= 5) && student.lastExpSubmissionDate !== todayStr;
                
                 content = `
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                             <h3 class="text-2xl font-bold">ê²½í—˜ì¹˜ ë“±ë¡ (${todayStr})</h3>
                             ${!canSubmit ? `<span class="px-3 py-1 bg-yellow-200 text-yellow-800 text-sm font-bold rounded-full">ì˜¤ëŠ˜ì€ ì´ë¯¸ ë“±ë¡í–ˆê±°ë‚˜, ì£¼ë§ì…ë‹ˆë‹¤.</span>` : ''}
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${generateExpItem('íƒœë„', 5, canSubmit)}
                            ${generateExpItem('ë´‰ì‚¬', 5, canSubmit)}
                            ${generateExpItem('ì¸ì‚¬', 5, canSubmit)}
                            ${generateExpItem('ê°€ì¹˜', 5, canSubmit)}
                            ${generateExpItem('ë°œí‘œ', 5, canSubmit)}
                            ${generateExpItem('ì¹­ì°¬', 5, canSubmit)}
                            ${generateExpItem('ì§ì—…', 10, canSubmit && dayOfWeek === 5)}
                            <div class="p-3 bg-white rounded-lg shadow">
                                <label class="font-semibold">ì¹­í˜¸ (ê°œë‹¹ 40ì )</label>
                                <select id="title-count" onchange="calculateTotalGainedExp()" class="mt-1 w-full p-1 border rounded" ${!canSubmit ? 'disabled' : ''}>
                                    <option value="0">0ê°œ</option><option value="1">1ê°œ</option><option value="2">2ê°œ</option><option value="3">3ê°œ</option>
                                </select>
                            </div>
                            <div class="p-3 bg-white rounded-lg shadow col-span-2 md:col-span-4">
                                <label class="font-semibold">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</label>
                                <div class="flex gap-2 mt-1">
                                    <input type="number" id="etc-exp" oninput="calculateTotalGainedExp()" class="p-1 border rounded w-1/4" placeholder="ì ìˆ˜" ${!canSubmit ? 'disabled' : ''}>
                                    <input type="text" id="etc-reason" class="p-1 border rounded w-3/4" placeholder="ì´ìœ " ${!canSubmit ? 'disabled' : ''}>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 text-right">
                             <span class="text-xl font-bold mr-4">ì´ íšë“ ê²½í—˜ì¹˜: <span id="total-gained-exp" class="text-red-500">0</span>ì </span>
                             <button onclick="submitExp()" class="px-8 py-3 bg-rose-500 text-white font-bold text-xl rounded-lg hover:bg-rose-600" ${!canSubmit ? 'disabled' : ''}>ë“±ë¡í•˜ê¸°</button>
                        </div>
                    </div>
                 `;
            }
            container.innerHTML = content;
        }

        function generateExpItem(name, exp, enabled) {
            return `
                <div class="p-3 bg-white rounded-lg shadow flex items-center justify-between">
                    <label for="exp-${name}" class="font-semibold">${name} (${exp}ì )</label>
                    <input type="checkbox" id="exp-${name}" data-exp="${exp}" onchange="calculateTotalGainedExp()" class="exp-checkbox h-6 w-6" ${!enabled ? 'disabled' : ''}>
                </div>
            `;
        }
        
        function renderStampsTab() {
            const container = document.getElementById('tab-content');
            const student = schoolData.students.find(s => s.id === selectedStudentId);
            let finalHTML = '';

            // --- ìš”ì²­ ê´€ë ¨ UI ---
            if (currentMode === 'teacher') {
                if (student.pendingStamps && student.pendingStamps.length > 0) {
                    finalHTML += `
                        <div class="p-4 mb-6 bg-orange-100 border-l-4 border-orange-500 rounded-r-lg">
                            <h4 class="text-lg font-bold text-orange-800 mb-2">í•™ìƒ ìš”ì²­ ëŒ€ê¸°</h4>
                            <ul class="space-y-2">
                                ${student.pendingStamps.map((stamp, index) => `
                                    <li class="flex justify-between items-center bg-white p-2 rounded shadow-sm">
                                        <span>${stamp.name} <span class="text-xs text-gray-500">(${stamp.date})</span></span>
                                        <div>
                                            <button onclick="handleStampRequest(${index}, true)" class="text-sm py-1 px-2 bg-green-500 text-white rounded hover:bg-green-600">ìŠ¹ì¸</button>
                                            <button onclick="handleStampRequest(${index}, false)" class="text-sm py-1 px-2 bg-red-500 text-white rounded hover:bg-red-600 ml-1">ë°˜ë ¤</button>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
            } else { // Student Mode
                finalHTML += `
                    <div class="p-4 mb-6 bg-sky-50 rounded-lg shadow">
                        <h3 class="text-xl font-bold text-sky-700 mb-3">ì˜¤ëŠ˜ ë°›ì„ ê°€ì¹˜ë„ì¥ ìš”ì²­</h3>
                        <div class="flex items-center gap-2">
                            <select id="stamp-request-select" class="flex-grow p-2 border rounded-md">
                                <optgroup label="ğŸŒ· ìƒí™œ">
                                    ${stampCategories.life.map(name => `<option value="${name}">${name}</option>`).join('')}
                                </optgroup>
                                <optgroup label="ğŸ“š í•™ìŠµ">
                                    ${stampCategories.learning.map(name => `<option value="${name}">${name}</option>`).join('')}
                                </optgroup>
                            </select>
                            <button onclick="requestStamp()" class="py-2 px-4 bg-sky-500 text-white font-semibold rounded-lg hover:bg-sky-600">ìš”ì²­</button>
                        </div>
                    </div>
                `;
                if (student.pendingStamps && student.pendingStamps.length > 0) {
                     finalHTML += `
                        <div class="p-4 mb-6 bg-gray-100 rounded-lg">
                            <h4 class="text-lg font-bold text-gray-700 mb-2">ìš”ì²­ ëŒ€ê¸°ì¤‘ì¸ ë„ì¥</h4>
                            <ul class="list-disc list-inside text-gray-600">
                                ${student.pendingStamps.map(stamp => `<li>${stamp.name} (${stamp.date})</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            }


            // --- ê¸°ì¡´ ê°€ì¹˜ë„ì¥ í‘œì‹œ UI ---
            let lifeStampsHTML = ``;
            stampCategories.life.forEach(name => {
                const count = student.stamps[name] || 0;
                if (currentMode === 'teacher') {
                     lifeStampsHTML += `
                        <div class="p-3 bg-white rounded-lg shadow flex justify-between items-center">
                            <span class="font-semibold">${name} (${count})</span>
                            <div>
                                <button onclick="updateStamp('${name}', 1)" class="w-8 h-8 bg-blue-500 text-white rounded-full text-lg">+</button>
                                <button onclick="updateStamp('${name}', -1)" class="w-8 h-8 bg-red-500 text-white rounded-full text-lg ml-1">-</button>
                            </div>
                        </div>`;
                } else {
                    const level1_stamps = Math.min(count, 10);
                    const level2_stamps = Math.max(0, Math.min(count - 10, 10));
                    const level3_stamps = Math.max(0, count - 20);
                    
                    lifeStampsHTML += `
                        <div class="p-3 bg-white rounded-lg shadow">
                            <p class="font-bold text-center">${name}</p>
                            <div class="text-xs text-center text-gray-600 mt-2 flex flex-col items-center">
                                ${level3_stamps > 0 ? `<span class="heart-level-3">3ë‹¨ê³„: ${level3_stamps}ê°œ</span>` : ''}
                                ${level2_stamps > 0 ? `<span class="heart-level-2">2ë‹¨ê³„: ${level2_stamps}ê°œ</span>` : ''}
                                ${level1_stamps > 0 ? `<span class="heart-level-1">1ë‹¨ê³„: ${level1_stamps}ê°œ</span>` : ''}
                                ${count === 0 ? '<span>ì—†ìŒ</span>' : ''}
                            </div>
                            <p class="text-center font-bold text-sm mt-1">${count}ê°œ</p>
                        </div>`;
                }
            });

            let learningStampsHTML = ``;
            stampCategories.learning.forEach(name => {
                const count = student.stamps[name] || 0;
                if (currentMode === 'teacher') {
                     learningStampsHTML += `
                        <div class="p-3 bg-white rounded-lg shadow flex justify-between items-center">
                            <span class="font-semibold">${name} (${count})</span>
                            <div>
                                <button onclick="updateStamp('${name}', 1)" class="w-8 h-8 bg-blue-500 text-white rounded-full text-lg">+</button>
                                <button onclick="updateStamp('${name}', -1)" class="w-8 h-8 bg-red-500 text-white rounded-full text-lg ml-1">-</button>
                            </div>
                        </div>`;
                } else {
                    const level1_stamps = Math.min(count, 10);
                    const level2_stamps = Math.max(0, Math.min(count - 10, 10));
                    const level3_stamps = Math.max(0, count - 20);

                    learningStampsHTML += `
                        <div class="p-3 bg-white rounded-lg shadow">
                            <p class="font-bold text-center">${name}</p>
                            <div class="text-xs text-center text-gray-600 mt-2 flex flex-col items-center">
                                ${level3_stamps > 0 ? `<span class="heart-level-3">3ë‹¨ê³„: ${level3_stamps}ê°œ</span>` : ''}
                                ${level2_stamps > 0 ? `<span class="heart-level-2">2ë‹¨ê³„: ${level2_stamps}ê°œ</span>` : ''}
                                ${level1_stamps > 0 ? `<span class="heart-level-1">1ë‹¨ê³„: ${level1_stamps}ê°œ</span>` : ''}
                                ${count === 0 ? '<span>ì—†ìŒ</span>' : ''}
                            </div>
                             <p class="text-center font-bold text-sm mt-1">${count}ê°œ</p>
                        </div>`;
                }
            });

            finalHTML += `
                <div class="space-y-6">
                    <div>
                        <h3 class="text-2xl font-bold mb-3 text-pink-600">ğŸŒ· ìƒí™œ</h3>
                        <div class="grid gap-3 stamp-grid">${lifeStampsHTML}</div>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold mb-3 text-indigo-600">ğŸ“š í•™ìŠµ</h3>
                        <div class="grid gap-3 stamp-grid">${learningStampsHTML}</div>
                    </div>
                </div>
            `;
            container.innerHTML = finalHTML;
        }

        function renderTitlesTab() {
            const container = document.getElementById('tab-content');
            const student = schoolData.students.find(s => s.id === selectedStudentId);
            
            let titlesHTML = student.titles.map((title, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="p-3 border-b">${title.date}</td>
                    <td class="p-3 border-b">${title.name}</td>
                    <td class="p-3 border-b">${title.growth}</td>
                    <td class="p-3 border-b text-center">
                        <button onclick="editTitle(${index})" class="text-sm py-1 px-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">ìˆ˜ì •</button>
                        <button onclick="deleteTitle(${index})" class="text-sm py-1 px-2 bg-red-500 text-white rounded hover:bg-red-600 ml-1">ì‚­ì œ</button>
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold">ì¹­í˜¸ ëª…ì˜ˆì˜ ì „ë‹¹</h3>
                        <button onclick="addTitle()" class="px-4 py-2 bg-blue-500 text-white font-bold rounded hover:bg-blue-600">ì¹­í˜¸ ì¶”ê°€</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="p-3">ë‚ ì§œ</th>
                                    <th class="p-3">íšë“í•œ ì¹­í˜¸</th>
                                    <th class="p-3">ì„±ì¥</th>
                                    <th class="p-3 text-center">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${titlesHTML || `<tr><td colspan="4" class="p-4 text-center text-gray-500">ì•„ì§ íšë“í•œ ì¹­í˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderSettingsTab() {
            const container = document.getElementById('tab-content');
            const student = schoolData.students.find(s => s.id === selectedStudentId);
            let content = '';
            if (currentMode === 'teacher') {
                content = `
                     <div class="p-4 bg-gray-50 rounded-lg max-w-md mx-auto">
                        <h3 class="text-2xl font-bold mb-4">êµì‚¬ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                        <div class="space-y-3">
                            <div>
                                <label for="current-pw" class="block font-semibold">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                                <input type="password" id="current-pw" class="p-2 border rounded w-full">
                            </div>
                            <div>
                                <label for="new-pw" class="block font-semibold">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                                <input type="password" id="new-pw" class="p-2 border rounded w-full">
                            </div>
                            <div>
                                <label for="confirm-pw" class="block font-semibold">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                                <input type="password" id="confirm-pw" class="p-2 border rounded w-full">
                            </div>
                            <button onclick="changeTeacherPassword()" class="w-full mt-4 px-6 py-2 bg-indigo-500 text-white font-bold rounded hover:bg-indigo-600">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                        </div>
                    </div>
                `;
            } else {
                content = `
                    <div class="p-4 bg-gray-50 rounded-lg max-w-md mx-auto">
                        <h3 class="text-2xl font-bold mb-4">í•™ìƒ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                         <div class="space-y-3">
                            <div>
                                <label for="current-pw-student" class="block font-semibold">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                                <input type="password" id="current-pw-student" class="p-2 border rounded w-full">
                            </div>
                            <div>
                                <label for="new-pw-student" class="block font-semibold">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                                <input type="password" id="new-pw-student" class="p-2 border rounded w-full">
                            </div>
                             <div>
                                <label for="confirm-pw-student" class="block font-semibold">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                                <input type="password" id="confirm-pw-student" class="p-2 border rounded w-full">
                            </div>
                            <button onclick="changeStudentPassword()" class="w-full mt-4 px-6 py-2 bg-indigo-500 text-white font-bold rounded hover:bg-indigo-600">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = content;
        }

        // ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
        function updateExp() {
            const level = parseInt(document.getElementById('level-input').value);
            const exp = parseInt(document.getElementById('exp-input').value);

            if (isNaN(level) || isNaN(exp) || level < 0 || exp < 0 || exp >= 100) {
                Swal.fire('ì˜¤ë¥˜', 'ë ˆë²¨ê³¼ ê²½í—˜ì¹˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. ê²½í—˜ì¹˜ëŠ” 0~99 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            const student = schoolData.students.find(s => s.id === selectedStudentId);
            student.totalExp = level * 100 + exp;
            saveData();
            renderContentArea();
            Swal.fire('ì„±ê³µ', 'ë ˆë²¨ê³¼ ê²½í—˜ì¹˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function calculateTotalGainedExp() {
            let total = 0;
            document.querySelectorAll('.exp-checkbox:checked').forEach(cb => {
                total += parseInt(cb.dataset.exp);
            });
            
            const titleCount = parseInt(document.getElementById('title-count').value) || 0;
            total += titleCount * 40;
            
            const etcExp = parseInt(document.getElementById('etc-exp').value) || 0;
            if (!isNaN(etcExp)) {
                total += etcExp;
            }
            
            document.getElementById('total-gained-exp').innerText = total;
        }

        function submitExp() {
            const totalExpGained = parseInt(document.getElementById('total-gained-exp').innerText);
            
            if (isNaN(totalExpGained) || totalExpGained <= 0) {
                Swal.fire('ì•Œë¦¼', 'íšë“í•œ ê²½í—˜ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                return;
            }

            const student = schoolData.students.find(s => s.id === selectedStudentId);
            student.totalExp += totalExpGained;

            const today = new Date();
            const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            student.lastExpSubmissionDate = dateString;

            saveData();
            renderContentArea();
            
            Swal.fire('ë“±ë¡ ì™„ë£Œ!', `ê²½í—˜ì¹˜ ${totalExpGained}ì ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success').then(() => {
                renderExpTab();
            });
        }
        
        function updateStamp(stampName, change) {
            const student = schoolData.students.find(s => s.id === selectedStudentId);
            student.stamps[stampName] += change;
            if (student.stamps[stampName] < 0) student.stamps[stampName] = 0;
            saveData();
            renderStampsTab();
        }

        function requestStamp() {
            const select = document.getElementById('stamp-request-select');
            const stampName = select.value;

            if (!stampName) return;

            const student = schoolData.students.find(s => s.id === selectedStudentId);
            const today = new Date();
            const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            student.pendingStamps.push({
                name: stampName,
                date: dateString
            });

            saveData();
            renderStampsTab();
            Swal.fire('ìš”ì²­ ì™„ë£Œ!', `${stampName} ë„ì¥ì„ ì„ ìƒë‹˜ê»˜ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function handleStampRequest(index, isApproved) {
            const student = schoolData.students.find(s => s.id === selectedStudentId);
            const pendingStamp = student.pendingStamps[index];

            if (isApproved) {
                if (!student.stamps[pendingStamp.name]) {
                    student.stamps[pendingStamp.name] = 0;
                }
                student.stamps[pendingStamp.name] += 1;
                Swal.fire('ìŠ¹ì¸ ì™„ë£Œ', `${pendingStamp.name} ìš”ì²­ì„ ìŠ¹ì¸í–ˆìŠµë‹ˆë‹¤.`, 'success');
            } else {
                Swal.fire('ë°˜ë ¤ ì™„ë£Œ', `${pendingStamp.name} ìš”ì²­ì„ ë°˜ë ¤í–ˆìŠµë‹ˆë‹¤.`, 'info');
            }

            student.pendingStamps.splice(index, 1);
            saveData();
            renderStampsTab();
        }

        // ì¹­í˜¸ ê´€ë ¨
        async function addTitle() {
            const { value: formValues } = await Swal.fire({
                title: 'ì¹­í˜¸ ì¶”ê°€',
                html:
                    '<input id="swal-input1" class="swal2-input" placeholder="íšë“í•œ ì¹­í˜¸">' +
                    '<input id="swal-input2" class="swal2-input" placeholder="ì„±ì¥í•œ ì ">',
                focusConfirm: false,
                preConfirm: () => {
                    return [
                        document.getElementById('swal-input1').value,
                        document.getElementById('swal-input2').value
                    ]
                }
            });

            if (formValues && formValues[0]) {
                const student = schoolData.students.find(s => s.id === selectedStudentId);
                const today = new Date();
                const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                
                student.titles.push({
                    date: dateString,
                    name: formValues[0],
                    growth: formValues[1]
                });
                saveData();
                renderTitlesTab();
            }
        }

        async function editTitle(index) {
            const student = schoolData.students.find(s => s.id === selectedStudentId);
            const title = student.titles[index];
            
            const { value: formValues } = await Swal.fire({
                title: 'ì¹­í˜¸ ìˆ˜ì •',
                html:
                    `<input id="swal-input1" class="swal2-input" placeholder="íšë“í•œ ì¹­í˜¸" value="${title.name}">` +
                    `<input id="swal-input2" class="swal2-input" placeholder="ì„±ì¥í•œ ì " value="${title.growth}">`,
                focusConfirm: false,
                preConfirm: () => {
                    return [
                        document.getElementById('swal-input1').value,
                        document.getElementById('swal-input2').value
                    ]
                }
            });

            if (formValues && formValues[0]) {
                student.titles[index].name = formValues[0];
                student.titles[index].growth = formValues[1];
                saveData();
                renderTitlesTab();
            }
        }

        function deleteTitle(index) {
            Swal.fire({
                title: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                text: "ì‚­ì œí•œ ì¹­í˜¸ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ì‚­ì œ',
                cancelButtonText: 'ì·¨ì†Œ'
            }).then((result) => {
                if (result.isConfirmed) {
                    const student = schoolData.students.find(s => s.id === selectedStudentId);
                    student.titles.splice(index, 1);
                    saveData();
                    renderTitlesTab();
                    Swal.fire('ì‚­ì œ ì™„ë£Œ!', 'ì¹­í˜¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }
            })
        }
        
        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
        function changeTeacherPassword() {
            const currentPw = document.getElementById('current-pw').value;
            const newPw = document.getElementById('new-pw').value;
            const confirmPw = document.getElementById('confirm-pw').value;

            if (currentPw !== schoolData.teacherPassword) {
                Swal.fire('ì˜¤ë¥˜', 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            if (!newPw || newPw !== confirmPw) {
                Swal.fire('ì˜¤ë¥˜', 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            schoolData.teacherPassword = newPw;
            saveData();
            Swal.fire('ì„±ê³µ', 'êµì‚¬ ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            renderSettingsTab();
        }

        function changeStudentPassword() {
            const student = schoolData.students.find(s => s.id === selectedStudentId);
            const currentPw = document.getElementById('current-pw-student').value;
            const newPw = document.getElementById('new-pw-student').value;
            const confirmPw = document.getElementById('confirm-pw-student').value;
            
            if (currentPw !== student.password) {
                 Swal.fire('ì˜¤ë¥˜', 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            if (!newPw || newPw !== confirmPw) {
                 Swal.fire('ì˜¤ë¥˜', 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            student.password = newPw;
            saveData();
            Swal.fire('ì„±ê³µ', 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            renderSettingsTab();
        }


        // ì•± ì´ˆê¸°í™”
        window.onload = function() {
            loadData();
            showInitialScreen();
        };
    </script>

</body>
</html>


